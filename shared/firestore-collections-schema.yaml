# Alchemist Platform - Firestore Collections Schema
# This document defines the structure of all Firestore collections used in the Alchemist platform.
# It serves as a reference for developers and helps maintain consistency across services.

collections:
  # ============================================================================
  # CORE COLLECTIONS
  # ============================================================================
  
  agents:
    description: "Agent management and configuration"
    fields:
      id: 
        type: string
        description: "Unique agent identifier"
        required: true
      name:
        type: string
        description: "Display name for the agent"
        required: true
      description:
        type: string
        description: "Agent description and purpose"
        required: true
      type:
        type: string
        description: "Agent type (general, code, research, writing, data, customer)"
        required: true
      owner_id:
        type: string
        description: "User ID of the agent owner"
        required: true
      deployment_status:
        type: string
        description: "Current deployment status (pending, building, deployed, failed, cancelled)"
        required: true
      active_deployment_id:
        type: string
        description: "ID of the currently active deployment"
        required: false
      service_url:
        type: string
        description: "URL of the deployed agent service"
        required: false
      created_at:
        type: timestamp
        description: "When the agent was created"
        required: true
      updated_at:
        type: timestamp
        description: "When the agent was last updated"
        required: true
      last_deployed_at:
        type: timestamp
        description: "When the agent was last deployed"
        required: false

  agent_deployments:
    description: "Agent deployment tracking and history"
    fields:
      id:
        type: string
        description: "Unique deployment identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent being deployed"
        required: true
      deployment_status:
        type: string
        description: "Deployment status (pending, building, deployed, failed, cancelled)"
        required: true
      created_at:
        type: timestamp
        description: "When the deployment was initiated"
        required: true
      updated_at:
        type: timestamp
        description: "When the deployment status was last updated"
        required: true

  agent_usage_summary:
    description: "Agent usage statistics and billing summary"
    fields:
      id:
        type: string
        description: "Unique summary identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      user_id:
        type: string
        description: "Reference to the user/owner"
        required: true
      total_interactions:
        type: number
        description: "Total number of interactions"
        required: true
      total_tokens:
        type: number
        description: "Total tokens consumed"
        required: true
      total_cost_usd:
        type: number
        description: "Total cost in USD"
        required: true
      created_at:
        type: timestamp
        description: "When the summary was created"
        required: true
      updated_at:
        type: timestamp
        description: "When the summary was last updated"
        required: true

  conversations:
    description: "Agent conversation logs and interactions"
    fields:
      id:
        type: string
        description: "Unique conversation identifier"
        required: true
      conversation_id:
        type: string
        description: "Session conversation identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      user_id:
        type: string
        description: "Reference to the user (optional for anonymous)"
        required: false
      message_content:
        type: string
        description: "User's message content"
        required: true
      agent_response:
        type: string
        description: "Agent's response content"
        required: true
      is_production:
        type: boolean
        description: "Whether this was a production interaction"
        required: true
      deployment_type:
        type: string
        description: "Type of deployment (development, staging, production)"
        required: true
      tokens:
        type: object
        description: "Token usage breakdown"
        required: true
        fields:
          prompt_tokens:
            type: number
            description: "Tokens used in the prompt"
            required: true
          completion_tokens:
            type: number
            description: "Tokens used in the completion"
            required: true
          total_tokens:
            type: number
            description: "Total tokens used"
            required: true
      cost_usd:
        type: number
        description: "Cost of this interaction in USD"
        required: true
      context:
        type: object
        description: "Additional context information"
        required: false
      timestamp:
        type: timestamp
        description: "When the interaction occurred"
        required: true
      created_at:
        type: timestamp
        description: "When the record was created"
        required: true

  communication_logs:
    description: "Communication logs and webhook events"
    fields:
      id:
        type: string
        description: "Unique log identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      timestamp:
        type: timestamp
        description: "When the communication occurred"
        required: true
      created_at:
        type: timestamp
        description: "When the log was created"
        required: true

  api_logs:
    description: "API request and response logs"
    fields:
      id:
        type: string
        description: "Unique log identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      user_id:
        type: string
        description: "Reference to the user"
        required: false
      endpoint:
        type: string
        description: "API endpoint that was called"
        required: true
      method:
        type: string
        description: "HTTP method (GET, POST, etc.)"
        required: true
      status_code:
        type: number
        description: "HTTP response status code"
        required: true
      response_time_ms:
        type: number
        description: "Response time in milliseconds"
        required: true
      timestamp:
        type: timestamp
        description: "When the API call occurred"
        required: true
      created_at:
        type: timestamp
        description: "When the log was created"
        required: true

  # ============================================================================
  # USER AND BILLING COLLECTIONS
  # ============================================================================

  user_accounts:
    description: "User account information and billing details"
    fields:
      id:
        type: string
        description: "Unique user identifier"
        required: true
      user_id:
        type: string
        description: "Firebase Auth user ID"
        required: true
      email:
        type: string
        description: "User's email address"
        required: true
      display_name:
        type: string
        description: "User's display name"
        required: true
      credit_balance:
        type: number
        description: "Current credit balance"
        required: true
      total_credits_purchased:
        type: number
        description: "Total credits purchased"
        required: true
      total_credits_used:
        type: number
        description: "Total credits consumed"
        required: true
      account_status:
        type: string
        description: "Account status (active, suspended, trial)"
        required: true
      trial_credits_remaining:
        type: number
        description: "Remaining trial credits"
        required: false
      created_at:
        type: timestamp
        description: "When the account was created"
        required: true
      updated_at:
        type: timestamp
        description: "When the account was last updated"
        required: true
      last_activity_at:
        type: timestamp
        description: "When the user was last active"
        required: false

  credit_transactions:
    description: "Credit purchase and usage transactions"
    fields:
      id:
        type: string
        description: "Unique transaction identifier"
        required: true
      user_id:
        type: string
        description: "Reference to the user"
        required: true
      transaction_type:
        type: string
        description: "Transaction type (purchase, usage, adjustment, refund)"
        required: true
      amount:
        type: number
        description: "Transaction amount (positive for purchases, negative for usage)"
        required: true
      payment_provider:
        type: string
        description: "Payment provider used (stripe, paypal, etc.)"
        required: false
      created_at:
        type: timestamp
        description: "When the transaction occurred"
        required: true

  # ============================================================================
  # KNOWLEDGE BASE COLLECTIONS
  # ============================================================================

  knowledge_files:
    description: "Knowledge base file metadata"
    fields:
      id:
        type: string
        description: "Unique file identifier"
        required: true
      file_id:
        type: string
        description: "File identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      user_id:
        type: string
        description: "Reference to the user who uploaded the file"
        required: true
      original_filename:
        type: string
        description: "Original filename"
        required: true
      storage_path:
        type: string
        description: "Path to the file in storage"
        required: true
      file_size_bytes:
        type: number
        description: "File size in bytes"
        required: true
      file_type:
        type: string
        description: "File type/extension"
        required: true
      chunk_count:
        type: number
        description: "Number of chunks created from this file"
        required: true
      processing_status:
        type: string
        description: "Processing status (pending, processing, completed, failed)"
        required: true
      created_at:
        type: timestamp
        description: "When the file was uploaded"
        required: true
      updated_at:
        type: timestamp
        description: "When the file was last updated"
        required: true

  knowledge_embeddings:
    description: "Knowledge base text chunks and embeddings"
    fields:
      id:
        type: string
        description: "Unique embedding identifier"
        required: true
      file_id:
        type: string
        description: "Reference to the source file"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      text_content:
        type: string
        description: "Text content of the chunk"
        required: true
      embedding_vector:
        type: array
        description: "Vector embedding of the text"
        required: true
      page_number:
        type: number
        description: "Page number in the source document"
        required: false
      chunk_index:
        type: number
        description: "Index of this chunk within the file"
        required: true
      created_at:
        type: timestamp
        description: "When the embedding was created"
        required: true

  # ============================================================================
  # TRAINING AND AI COLLECTIONS
  # ============================================================================

  training_jobs:
    description: "AI training job tracking"
    fields:
      id:
        type: string
        description: "Unique training job identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent being trained"
        required: true
      user_id:
        type: string
        description: "Reference to the user who initiated training"
        required: true
      status:
        type: string
        description: "Training status (pending, processing, completed, failed)"
        required: true
      created_at:
        type: timestamp
        description: "When the training job was created"
        required: true
      updated_at:
        type: timestamp
        description: "When the training job was last updated"
        required: true

  # ============================================================================
  # INTEGRATION COLLECTIONS
  # ============================================================================

  integration_channels:
    description: "Integration channel configurations (WhatsApp, Slack, etc.)"
    fields:
      id:
        type: string
        description: "Unique integration identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      user_id:
        type: string
        description: "Reference to the user who created the integration"
        required: true
      channel_type:
        type: string
        description: "Type of integration (whatsapp, slack, discord, etc.)"
        required: true
      configuration:
        type: object
        description: "Channel-specific configuration"
        required: true
      status:
        type: string
        description: "Integration status (active, inactive, failed)"
        required: true
      created_at:
        type: timestamp
        description: "When the integration was created"
        required: true
      updated_at:
        type: timestamp
        description: "When the integration was last updated"
        required: true

  # ============================================================================
  # GLOBAL NARRATIVE FRAMEWORK COLLECTIONS
  # ============================================================================

  agent_identities:
    description: "Agent narrative identities and personality development"
    fields:
      id:
        type: string
        description: "Unique identity identifier"
        required: true
      narrative_identity_id:
        type: string
        description: "Narrative identity identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      development_stage:
        type: string
        description: "Current development stage of the agent"
        required: true
      narrative_coherence_score:
        type: number
        description: "Score indicating narrative consistency"
        required: true
      responsibility_score:
        type: number
        description: "Score indicating agent's responsibility level"
        required: true
      experience_points:
        type: number
        description: "Accumulated experience points"
        required: true
      total_interactions:
        type: number
        description: "Total number of interactions"
        required: true
      defining_moments_count:
        type: number
        description: "Number of defining moments in agent's history"
        required: true
      personality_traits:
        type: object
        description: "Agent's personality traits"
        required: true
      core_values:
        type: array
        description: "Agent's core values"
        required: true
      primary_goals:
        type: array
        description: "Agent's primary goals"
        required: true
      motivations:
        type: array
        description: "Agent's motivations"
        required: true
      fears:
        type: array
        description: "Agent's fears or concerns"
        required: true
      current_arc:
        type: string
        description: "Current narrative arc"
        required: true
      story_elements:
        type: object
        description: "Story elements and themes"
        required: true
      character_development:
        type: object
        description: "Character development progress"
        required: true
      created_at:
        type: timestamp
        description: "When the identity was created"
        required: true
      updated_at:
        type: timestamp
        description: "When the identity was last updated"
        required: true

  agent_interactions:
    description: "Agent interaction records for narrative tracking"
    fields:
      id:
        type: string
        description: "Unique interaction identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      interaction_type:
        type: string
        description: "Type of interaction"
        required: true
      participants:
        type: array
        description: "Participants in the interaction"
        required: true
      impact_level:
        type: string
        description: "Impact level of the interaction"
        required: true
      emotional_tone:
        type: string
        description: "Emotional tone of the interaction"
        required: true
      narrative_significance:
        type: string
        description: "Significance in the narrative"
        required: true
      personality_impact:
        type: object
        description: "Impact on personality traits"
        required: true
      learning_outcome:
        type: string
        description: "What the agent learned"
        required: false
      responsibility_impact:
        type: number
        description: "Impact on responsibility score"
        required: true
      timestamp:
        type: timestamp
        description: "When the interaction occurred"
        required: true
      created_at:
        type: timestamp
        description: "When the record was created"
        required: true

  agent_memories:
    description: "Agent memory storage for narrative continuity"
    fields:
      id:
        type: string
        description: "Unique memory identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      memory_type:
        type: string
        description: "Type of memory (episodic, semantic, etc.)"
        required: true
      text_content:
        type: string
        description: "Memory content"
        required: true
      consolidation_strength:
        type: number
        description: "How well consolidated this memory is"
        required: true
      importance_score:
        type: number
        description: "Importance score of this memory"
        required: true
      emotional_valence:
        type: number
        description: "Emotional valence of the memory"
        required: true
      tags:
        type: array
        description: "Tags associated with the memory"
        required: true
      timestamp:
        type: timestamp
        description: "When the memory was formed"
        required: true
      created_at:
        type: timestamp
        description: "When the memory was stored"
        required: true
      updated_at:
        type: timestamp
        description: "When the memory was last updated"
        required: true

  evolution_events:
    description: "Agent evolution and development events"
    fields:
      id:
        type: string
        description: "Unique evolution event identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      event_type:
        type: string
        description: "Type of evolution event"
        required: true
      trigger:
        type: string
        description: "What triggered this evolution"
        required: true
      pre_evolution_state:
        type: object
        description: "Agent state before evolution"
        required: true
      post_evolution_state:
        type: object
        description: "Agent state after evolution"
        required: true
      changes:
        type: object
        description: "Specific changes that occurred"
        required: true
      timestamp:
        type: timestamp
        description: "When the evolution occurred"
        required: true
      created_at:
        type: timestamp
        description: "When the event was recorded"
        required: true

  responsibility_assessments:
    description: "Agent responsibility assessments and ethical evaluations"
    fields:
      id:
        type: string
        description: "Unique assessment identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      action_type:
        type: string
        description: "Type of action being assessed"
        required: true
      responsibility_level:
        type: string
        description: "Level of responsibility"
        required: true
      contributing_factors:
        type: array
        description: "Factors that contributed to the assessment"
        required: true
      mitigation_actions:
        type: array
        description: "Actions taken to mitigate issues"
        required: false
      accountability_score:
        type: number
        description: "Accountability score"
        required: true
      ethical_weight:
        type: number
        description: "Ethical weight of the action"
        required: true
      decision_quality:
        type: number
        description: "Quality of the decision made"
        required: true
      learning_potential:
        type: number
        description: "Potential for learning from this assessment"
        required: true
      timestamp:
        type: timestamp
        description: "When the assessment was made"
        required: true
      created_at:
        type: timestamp
        description: "When the assessment was recorded"
        required: true

  global_events:
    description: "Global events affecting the narrative framework"
    fields:
      id:
        type: string
        description: "Unique global event identifier"
        required: true
      event_type:
        type: string
        description: "Type of global event"
        required: true
      affected_agents:
        type: array
        description: "Agents affected by this event"
        required: true
      impact_level:
        type: string
        description: "Impact level of the event"
        required: true
      timestamp:
        type: timestamp
        description: "When the event occurred"
        required: true
      created_at:
        type: timestamp
        description: "When the event was recorded"
        required: true

  agent_relationships:
    description: "Relationships between agents in the narrative framework"
    fields:
      id:
        type: string
        description: "Unique relationship identifier"
        required: true
      agent_id_1:
        type: string
        description: "Reference to the first agent"
        required: true
      agent_id_2:
        type: string
        description: "Reference to the second agent"
        required: true
      relationship_type:
        type: string
        description: "Type of relationship"
        required: true
      strength:
        type: number
        description: "Strength of the relationship"
        required: true
      created_at:
        type: timestamp
        description: "When the relationship was established"
        required: true
      updated_at:
        type: timestamp
        description: "When the relationship was last updated"
        required: true

  # ============================================================================
  # STORY-LOSS METRIC & EPISTEMIC AUTONOMY COLLECTIONS
  # ============================================================================

  agent_graphs:
    description: "Agent narrative graphs for Global Narrative Framework"
    fields:
      id:
        type: string
        description: "Unique graph identifier (agent_id)"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      nodes:
        type: array
        description: "Graph nodes (beliefs, facts, actions)"
        required: true
        fields:
          - id: string
          - type: string  # fact, goal, action, belief, event
          - content: string
          - timestamp: timestamp
          - confidence: number
          - metadata: object
      edges:
        type: array
        description: "Graph edges (relationships between nodes)"
        required: true
        fields:
          - id: string
          - source_id: string
          - target_id: string
          - type: string  # belief, action, causal, temporal, contradiction
          - weight: number
          - confidence: number
          - timestamp: timestamp
          - metadata: object
      last_updated:
        type: timestamp
        description: "When the graph was last modified"
        required: true
      version:
        type: number
        description: "Graph version number"
        required: true

  agent_metrics:
    description: "Agent-specific metrics including story-loss data"
    fields:
      id:
        type: string
        description: "Unique metrics identifier (agent_id)"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      story_loss:
        type: number
        description: "Current story-loss value (0-1)"
        required: true
      timestamp:
        type: timestamp
        description: "When the metric was recorded"
        required: true
      metadata:
        type: object
        description: "Additional metric metadata"
        required: false
      version:
        type: number
        description: "Metric version"
        required: true

  agent_metrics/{agent_id}/time_series:
    description: "Time-series story-loss data for 24h tracking"
    fields:
      id:
        type: string
        description: "Time-based document ID (YYYYMMDD_HHMMSS)"
        required: true
      story_loss:
        type: number
        description: "Story-loss value at this time"
        required: true
      timestamp:
        type: timestamp
        description: "When the measurement was taken"
        required: true
      metadata:
        type: object
        description: "Measurement context and details"
        required: false

  agents/{agent_id}/cognitive_memory:
    description: "Agent cognitive memory including Umwelt data"
    subcollections:
      umwelt:
        description: "Agent's filtered world snapshot"
        fields:
          id:
            type: string
            description: "Document ID (always 'umwelt')"
            required: true
          agent_id:
            type: string
            description: "Reference to the agent"
            required: true
          umwelt_data:
            type: object
            description: "Key-value pairs of environmental signals"
            required: true
          last_updated:
            type: timestamp
            description: "When Umwelt was last updated"
            required: true

  agent_events:
    description: "System events for story-loss and Umwelt conflicts"
    fields:
      id:
        type: string
        description: "Unique event identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      event_type:
        type: string
        description: "Type of event (story_loss_threshold, umwelt_conflict)"
        required: true
      story_loss:
        type: number
        description: "Story-loss value (for story-loss events)"
        required: false
      threshold:
        type: number
        description: "Threshold value that was exceeded"
        required: false
      threshold_exceeded:
        type: boolean
        description: "Whether threshold was exceeded"
        required: false
      conflict_type:
        type: string
        description: "Type of conflict (for Umwelt events)"
        required: false
      severity:
        type: string
        description: "Event severity (low, medium, high, critical)"
        required: false
      confidence:
        type: number
        description: "Confidence in the conflict detection"
        required: false
      description:
        type: string
        description: "Event description"
        required: true
      gnf_nodes_involved:
        type: array
        description: "GNF node IDs involved in conflict"
        required: false
      umwelt_keys_involved:
        type: array
        description: "Umwelt keys involved in conflict"
        required: false
      suggested_resolution:
        type: string
        description: "Suggested resolution for the conflict"
        required: false
      timestamp:
        type: timestamp
        description: "When the event occurred"
        required: true
      requires_attention:
        type: boolean
        description: "Whether event requires human attention"
        required: true
      auto_resolvable:
        type: boolean
        description: "Whether event can be auto-resolved"
        required: false

  minion_tasks:
    description: "Self-reflection and minion agent tasks"
    fields:
      id:
        type: string
        description: "Unique task identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      minion_type:
        type: string
        description: "Type of minion (self_reflection, narrative_repair)"
        required: true
      trigger_event:
        type: string
        description: "Event that triggered the task"
        required: true
      trigger_data:
        type: object
        description: "Data from the triggering event"
        required: true
      priority:
        type: number
        description: "Task priority (1-5)"
        required: true
      max_retries:
        type: number
        description: "Maximum number of retry attempts"
        required: true
      current_retry:
        type: number
        description: "Current retry attempt"
        required: true
      status:
        type: string
        description: "Task status (idle, active, completed, failed, retrying)"
        required: true
      created_at:
        type: timestamp
        description: "When the task was created"
        required: true
      started_at:
        type: timestamp
        description: "When the task was started"
        required: false
      completed_at:
        type: timestamp
        description: "When the task was completed"
        required: false
      result:
        type: object
        description: "Task execution result"
        required: false
      error_message:
        type: string
        description: "Error message if task failed"
        required: false

  minion_logs:
    description: "Logs of minion agent activities"
    fields:
      id:
        type: string
        description: "Unique log identifier"
        required: true
      minion_type:
        type: string
        description: "Type of minion that logged activity"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      activity:
        type: string
        description: "Description of the activity"
        required: true
      timestamp:
        type: timestamp
        description: "When the activity occurred"
        required: true
      metadata:
        type: object
        description: "Additional activity metadata"
        required: false

  alerts:
    description: "System alerts for story-loss and conflicts"
    fields:
      id:
        type: string
        description: "Unique alert identifier"
        required: true
      rule_id:
        type: string
        description: "ID of the alert rule that triggered"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent (if applicable)"
        required: false
      alert_type:
        type: string
        description: "Type of alert (story_loss_threshold, umwelt_conflict)"
        required: true
      severity:
        type: string
        description: "Alert severity (info, warning, error, critical)"
        required: true
      status:
        type: string
        description: "Alert status (active, acknowledged, resolved, suppressed)"
        required: true
      title:
        type: string
        description: "Alert title"
        required: true
      description:
        type: string
        description: "Alert description"
        required: true
      event_data:
        type: object
        description: "Original event data that triggered alert"
        required: true
      created_at:
        type: timestamp
        description: "When the alert was created"
        required: true
      updated_at:
        type: timestamp
        description: "When the alert was last updated"
        required: true
      acknowledged_at:
        type: timestamp
        description: "When the alert was acknowledged"
        required: false
      resolved_at:
        type: timestamp
        description: "When the alert was resolved"
        required: false
      acknowledged_by:
        type: string
        description: "User who acknowledged the alert"
        required: false

  alert_rules:
    description: "Alert rule definitions and configurations"
    fields:
      id:
        type: string
        description: "Unique alert rule identifier"
        required: true
      name:
        type: string
        description: "Rule name"
        required: true
      alert_type:
        type: string
        description: "Type of alert this rule handles"
        required: true
      severity:
        type: string
        description: "Severity level for alerts from this rule"
        required: true
      conditions:
        type: object
        description: "Conditions that trigger the alert"
        required: true
      enabled:
        type: boolean
        description: "Whether the rule is active"
        required: true
      cooldown_minutes:
        type: number
        description: "Cooldown period between alerts"
        required: true
      description:
        type: string
        description: "Rule description"
        required: false

  notification_channels:
    description: "Notification channel configurations"
    fields:
      id:
        type: string
        description: "Unique channel identifier"
        required: true
      type:
        type: string
        description: "Channel type (email, webhook, sms)"
        required: true
      enabled:
        type: boolean
        description: "Whether the channel is active"
        required: true
      recipients:
        type: array
        description: "List of recipients (for email/sms)"
        required: false
      url:
        type: string
        description: "Webhook URL (for webhook channels)"
        required: false
      min_severity:
        type: string
        description: "Minimum severity to send notifications"
        required: true

  traces:
    description: "Explain-Your-Work trace data for agent decisions"
    fields:
      id:
        type: string
        description: "Unique trace identifier"
        required: true
      agent_id:
        type: string
        description: "Reference to the agent"
        required: true
      conversation_id:
        type: string
        description: "Reference to the conversation"
        required: false
      start_time:
        type: timestamp
        description: "When the trace started"
        required: true
      end_time:
        type: timestamp
        description: "When the trace ended"
        required: false
      status:
        type: string
        description: "Trace status (active, completed, failed)"
        required: true
      total_steps:
        type: number
        description: "Total number of steps in trace"
        required: true
      steps:
        type: array
        description: "Array of trace steps with Umwelt diffs"
        required: true
        fields:
          - id: string
          - type: string  # thinking, action, observation, decision
          - title: string
          - description: string
          - start_time: timestamp
          - end_time: timestamp
          - reasoning: string
          - input: object
          - output: object
          - umwelt_diff: object
          - conflicts: array
          - metrics: object

# ============================================================================
# COLLECTION USAGE GUIDELINES
# ============================================================================

usage_guidelines:
  naming_conventions:
    - "All collection names use snake_case"
    - "Field names use snake_case consistently"
    - "Timestamps use server_timestamp() for creation"
    - "IDs are generated using Firebase document IDs"
  
  required_fields:
    - "All documents must have created_at timestamp"
    - "Most documents should have updated_at timestamp"
    - "Use consistent field naming across collections"
  
  indexing_strategy:
    - "Index frequently queried fields"
    - "Create composite indexes for complex queries"
    - "Consider query patterns when designing indexes"
  
  security_rules:
    - "Implement proper security rules for each collection"
    - "Ensure users can only access their own data"
    - "Validate data structure in security rules"
  
  data_validation:
    - "Validate collection names using validate_collection_usage()"
    - "Use standardized field names from DocumentFields"
    - "Implement proper error handling for invalid data"